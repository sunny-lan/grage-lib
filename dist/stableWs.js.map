{"version":3,"file":"stableWs.js","sourceRoot":"","sources":["../src/stableWs.ts"],"names":[],"mappings":";;AAAA,6CAAuE;AAMvE,MAAqB,QAAQ;IAA7B;QACY,oBAAe,GAAoB,4BAAe,CAAC,YAAY,CAAA;QAmC/D,uBAAkB,GAA2B,IAAI,GAAG,EAAqB,CAAA;QAiBzE,iBAAY,GAAqB,IAAI,GAAG,EAAe,CAAC;IAiBpE,CAAC;IAhEW,EAAE;;QACN,IAAI,CAAA,MAAA,IAAI,CAAC,GAAG,0CAAE,UAAU,MAAK,YAAY,CAAC,OAAO,IAAI,CAAA,MAAA,IAAI,CAAC,GAAG,0CAAE,UAAU,MAAK,YAAY,CAAC,MAAM,EAAE,CAAC;YAChG,IAAI,CAAC,WAAW,EAAE,CAAA;QACtB,CAAC;QAED,IAAI,IAAI,CAAC,GAAG,KAAK,SAAS,EAAE,CAAC;YACzB,IAAI,CAAC,GAAG,GAAG,IAAI,YAAY,CAAC,IAAI,CAAC,GAAG,CAAC,CAAA;YACrC,IAAI,CAAC,GAAG,CAAC,SAAS,GAAG,IAAI,CAAC,aAAa,CAAC,IAAI,CAAC,IAAI,CAAC,CAAA;QACtD,CAAC;QACD,OAAO,IAAI,CAAC,GAAG,CAAA;IACnB,CAAC;IAED,KAAK,CAAC,GAAW;QACb,IAAI,CAAC,GAAG,GAAG,GAAG,CAAA;QACd,IAAI,CAAC,EAAE,EAAE,CAAA;QACT,OAAO,IAAI,CAAC,WAAW,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;IACvC,CAAC;IAEO,WAAW;QACf,aAAa;QACb,IAAI,CAAC,GAAG,CAAC,SAAS,GAAG,IAAI,CAAC;QAC1B,IAAI,CAAC,GAAG,GAAG,SAAS,CAAC;QACrB,IAAI,CAAC,eAAe,CAAC,4BAAe,CAAC,YAAY,CAAC,CAAA;IACtD,CAAC;IAED,kBAAkB;QACd,OAAO,IAAI,CAAC,eAAe,CAAA;IAC/B,CAAC;IAKD,wBAAwB,CAAC,QAA2B;QAChD,QAAQ,CAAC,IAAI,CAAC,kBAAkB,EAAE,CAAC,CAAA;QACnC,IAAI,CAAC,kBAAkB,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAA;QACrC,OAAO,GAAG,EAAE,CAAC,IAAI,CAAC,kBAAkB,CAAC,MAAM,CAAC,QAAQ,CAAC,CAAA;IACzD,CAAC;IAEO,eAAe,CAAC,KAAsB;QAC1C,IAAI,IAAI,CAAC,eAAe,IAAI,KAAK,EAAE,CAAC;YAChC,IAAI,CAAC,eAAe,GAAG,KAAK,CAAA;YAC5B,KAAK,MAAM,QAAQ,IAAI,IAAI,CAAC,kBAAkB,EAAE,CAAC;gBAC7C,QAAQ,CAAC,KAAK,CAAC,CAAA;YACnB,CAAC;QACL,CAAC;IACL,CAAC;IAID,SAAS,CAAC,QAAqB;QAC3B,IAAI,CAAC,YAAY,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAA;QAC/B,OAAO,GAAG,EAAE,CAAC,IAAI,CAAC,YAAY,CAAC,MAAM,CAAC,QAAQ,CAAC,CAAA;IACnD,CAAC;IAGD,IAAI,CAAC,IAAkB;QACnB,IAAI,CAAC,EAAE,EAAE,CAAC,IAAI,CAAC,IAAI,CAAC,CAAA;IACxB,CAAC;IAEO,aAAa,CAAC,IAAkB;QACpC,KAAK,MAAM,QAAQ,IAAI,IAAI,CAAC,YAAY,EAAE,CAAC;YACvC,QAAQ,CAAC,IAAI,CAAC,CAAA;QAClB,CAAC;IACL,CAAC;CACJ;AAtED,2BAsEC","sourcesContent":["import {ConnectionState, IWebsocket, WebsocketMsg} from \"./IWebsocket\";\r\nimport websocket from 'we'\r\n\r\ntype ConnStateListener = (state: ConnectionState) => void;\r\ntype MsgListener = (data: WebsocketMsg) => void;\r\n\r\nexport default class StableWs implements IWebsocket {\r\n    private connectionState: ConnectionState = ConnectionState.Disconnected\r\n\r\n    declare private ws_?: any\r\n    private url: string\r\n\r\n    private ws(): w3cwebsocket {\r\n        if (this.ws_?.readyState === w3cwebsocket.CLOSING || this.ws_?.readyState === w3cwebsocket.CLOSED) {\r\n            this.terminateWs()\r\n        }\r\n\r\n        if (this.ws_ === undefined) {\r\n            this.ws_ = new w3cwebsocket(this.url)\r\n            this.ws_.onmessage = this.handleMessage.bind(this)\r\n        }\r\n        return this.ws_\r\n    }\r\n\r\n    begin(url: string): () => void {\r\n        this.url = url\r\n        this.ws()\r\n        return this.terminateWs.bind(this);\r\n    }\r\n\r\n    private terminateWs() {\r\n        // @ts-ignore\r\n        this.ws_.onmessage = null;\r\n        this.ws_ = undefined;\r\n        this.updateConnState(ConnectionState.Disconnected)\r\n    }\r\n\r\n    getConnectionState(): ConnectionState {\r\n        return this.connectionState\r\n    }\r\n\r\n\r\n    private connStateListeners: Set<ConnStateListener> = new Set<ConnStateListener>()\r\n\r\n    onConnectionStateChanged(callback: ConnStateListener): () => void {\r\n        callback(this.getConnectionState())\r\n        this.connStateListeners.add(callback)\r\n        return () => this.connStateListeners.delete(callback)\r\n    }\r\n\r\n    private updateConnState(state: ConnectionState) {\r\n        if (this.connectionState != state) {\r\n            this.connectionState = state\r\n            for (const listener of this.connStateListeners) {\r\n                listener(state)\r\n            }\r\n        }\r\n    }\r\n\r\n    private msgListeners: Set<MsgListener> = new Set<MsgListener>();\r\n\r\n    onMessage(callback: MsgListener): () => void {\r\n        this.msgListeners.add(callback)\r\n        return () => this.msgListeners.delete(callback)\r\n    }\r\n\r\n\r\n    send(data: WebsocketMsg): void {\r\n        this.ws().send(data)\r\n    }\r\n\r\n    private handleMessage(data: WebsocketMsg) {\r\n        for (const listener of this.msgListeners) {\r\n            listener(data)\r\n        }\r\n    }\r\n}"]}
{"version":3,"file":"StableWs.js","sourceRoot":"","sources":["../src/StableWs.ts"],"names":[],"mappings":"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","sourcesContent":["import {\r\n    ConnectionState,\r\n    ConnStateListener,\r\n    IW3CWebsocket,\r\n    IW3CWebsocketObj,\r\n    IWebsocket,\r\n    MsgListener,\r\n    W3CWebsocketMsg,\r\n    WebsocketMsg\r\n} from \"./IWebsocket\";\r\nimport {w3cwebsocket as _W3CWebSocket} from \"websocket\";\r\n\r\nconst w3cwebsocket:IW3CWebsocket=_W3CWebSocket;\r\n\r\nconst noop=()=>{};\r\n\r\nexport default class StableWs implements IWebsocket {\r\n    private connectionState: ConnectionState = ConnectionState.Disconnected\r\n\r\n    declare private ws_?: IW3CWebsocketObj\r\n    private url: string\r\n    private connStateListeners: Set<ConnStateListener> = new Set<ConnStateListener>()\r\n    private msgListeners: Set<MsgListener> = new Set<MsgListener>();\r\n\r\n\r\n    begin(url: string): () => void {\r\n        this.url = url\r\n        this.ws()\r\n        return this.terminateWs.bind(this);\r\n    }\r\n\r\n    getConnectionState(): ConnectionState {\r\n        return this.connectionState\r\n    }\r\n\r\n    onConnectionStateChanged(callback: ConnStateListener): () => void {\r\n        callback(this.getConnectionState())\r\n        this.connStateListeners.add(callback)\r\n        return () => this.connStateListeners.delete(callback)\r\n    }\r\n\r\n    onMessage(callback: MsgListener): () => void {\r\n        this.msgListeners.add(callback)\r\n        return () => this.msgListeners.delete(callback)\r\n    }\r\n\r\n    send(data: WebsocketMsg): void {\r\n        if(this.connectionState===ConnectionState.Disconnected)\r\n            throw Error('Send called while disconnected')\r\n\r\n        this.ws().send(data)\r\n    }\r\n\r\n\r\n    private updateConnState(state: ConnectionState) {\r\n        if (this.connectionState != state) {\r\n            this.connectionState = state\r\n            for (const listener of this.connStateListeners) {\r\n                listener(state)\r\n            }\r\n        }\r\n    }\r\n\r\n    private ws(): IW3CWebsocketObj {\r\n        if (this.ws_?.readyState === w3cwebsocket.CLOSING || this.ws_?.readyState === w3cwebsocket.CLOSED) {\r\n            this.terminateWs()\r\n        }\r\n\r\n        if (this.ws_ === undefined) {\r\n            this.ws_ = new w3cwebsocket(this.url)\r\n            this.ws_.onmessage = this.handleMessage.bind(this)\r\n            this.ws_.onopen = ()=>this.updateConnState(ConnectionState.Connected)\r\n            this.ws_.onclose= this.terminateWs.bind(this)\r\n            this.ws_.onerror=(err)=>{\r\n                console.error(err)\r\n                this.terminateWs()\r\n            }\r\n        }\r\n        return this.ws_\r\n    }\r\n\r\n\r\n    private terminateWs() {\r\n        this.ws_!.onmessage = null;\r\n        this.ws_!.onclose=noop;\r\n        this.ws_!.onopen=noop;\r\n        this.ws_!.onerror=noop;\r\n\r\n        this.ws_ = undefined;\r\n        this.updateConnState(ConnectionState.Disconnected)\r\n    }\r\n\r\n    private handleMessage(data: W3CWebsocketMsg) {\r\n        for (const listener of this.msgListeners) {\r\n            listener(data.data)\r\n        }\r\n    }\r\n}"]}